#### Demo configuration file for LVM processing srcipt. Actual version can be generated by create_toml_file.py script
# =======================================
# ==== General control of the workflow ====
# =======================================
nprocs = 10 # number of processes to use for parallelization
default_output_dir = "/data/LVM/Reduced/" # default directory where reduced data and products will be copied/saved. Could be overwritten by the second argument in of the script
drp_sas_version = '1.1.1'
dap_sas_version = '1.1.0'
drp_local_version = '1.1.1dev'
server_group_id = 10699

[steps] # true = run step; false = skip
download = true  # check what to download in [download] section
update_metadata = false  # for drp only
reduction = false  # run drp locally
create_single_rss = false # only if you want to create a single RSS file with all fibers (includes sigma-clipping for fibers with same coordinates)
analyse_rss = true  # fit Gaussians or calculate moments and save table with fluxes/velocities/widths (see [imaging] and [imaging.lines] sections)
create_images = true  # create fits images for individual lines (see [imaging] and [imaging.lines] sections)
binning = false  # voronoi binning of the spectra (see [binning] section)
spectra_extraction = false  # extract spectra integrated in the desired ds9 region (see [extraction] section)
fit_with_dap = false # fit extracted or binned spectrum with DAP (see [dap_fitting] section)

create_cube = false  # create datacube, if really needed. This is not well-tested. If you really need data cube - better use Hector's script

# =======================================
# === Control of downloading process
# =======================================
[download]
force_download = false # will not download files if they already exist
download_reduced = true # if you want to download reduced data from SAS. No needs to do update_metadata and reduction then
include_cframes = false # Set true if CFrames should be downloaded from SAS. By default, only SFrames will be downloaded
download_raw = false # set false if you want to download reduced files and agcam images only
download_agcam = false # set true if you want to download agcam images (they are necessary for data reduction, but not necessary if you work with already reduced frames)
download_dap = true

# =======================================
# === Control of data reduction
# =======================================
[reduction]
reduce_parallel = false # if true, then drp will run in parallel threads. This will use all processors on the server, so other users will not able to do anything. Avoid this unless you need this done urgently
wham_sky_only = false # set true if you want to include only sky from the darkest sky patch (wham).
copy_cframes = false # Set true if CFrames should be copied to the object folder after reduction is done. By default, only SFrames will be copied

# =======================================
# === Control of imaging in individual lines
# =======================================
[imaging]
use_dap = false
include_sky = false # if true, then subtracted sky will be added back before the flux extraction
use_single_rss_file = false # if true, then creates single RSS file with all individual fibers and process this file.
use_binned_rss_file = false # if true, then process binned RSS file.
use_extracted_rss_file = false # if true, then process extracted RSS file (i.e. integrated spectra based on ds9 masks)
override_flux_table = true # if true, then overwrites table with measured fluxes every time (otherwise - tries to add new/update existing measurements instead)
pxscale = 15 # Pixel scale (in arcsec) for output image
sigma = 2 # arcsec; standard deviation for calculating of the weights of neighbouringfibers
r_lim = 50 # arcsec; maximal radius to limit the fibers to be considered in flux calculation for a given position
fiber_pos_precision = 1.5 # Spectra from the fibers with positions deviating by less than this value (in arcsec) are combined with sigma-clipping before the analysis

# =======================================
# === Control for Voronoi binning
# =======================================
[binning]
use_binmap = false
maps_source = 'maps'
mask_ds9_suffix = '_bin_exclude.reg'
line = 'SII6717'
target_sn = 300
correct_vel_line = 'Ha'

# =======================================
# === Control for spectra extraction
# =======================================
[extraction]
file_ds9_suffix = '_ds9.reg'
mask_ds9_suffix = '_mask_ds9.reg'
correct_vel_line = 'Ha'
file_output_suffix = '_extracted.fits'

# =======================================
# === Control for DAP fitting
# =======================================
[dap_fitting]
fit_mode = 'rss' # can be 'extracted' (i.e. based on ds9-masks), 'binned' (i.e. extracted in voronoi bins) or 'rss' (i.e. huge single RSS file)


# =======================================
# ====== Setup for lines to measure =====
# =======================================

# # # === Moment0 maps =====================
[[imaging.lines]] # One block per line for output image
line = 'Ha_mom0' # name of the line (arbitrary)
wl_range = [6561, 6564] # rest-frame wavelength range for the line
cont_range = [6530, 6540, 6605, 6620]  # rest-frame wavelength range for the continuum (w00, w01, w10, w11)

[[imaging.lines]]
line = 'OIII5007_mom0'
wl_range = [5003, 5010]
cont_range = [4831, 4851, 5030, 5050]

[[imaging.lines]]
line = 'SIIsum_mom0'
wl_range = [6713, 6721, 6727, 6735] # Sum both lines
cont_range = [6640, 6665, 6745, 6770]

[[imaging.lines]]
line = 'NII6584_mom0'
wl_range = [6581, 6586]
cont_range = [6530, 6542, 6620, 6640]

[[imaging.lines]]
line = 'Hb_mom0'
wl_range = [4858, 4865]
cont_range = [4820, 4840, 4875, 4890]

[[imaging.lines]]
line = 'Hg_mom0'
wl_range = [4337, 4343]
cont_range = [4415, 4335, 4345, 4355]

[[imaging.lines]]
line = 'HeII_mom0'
wl_range = [4678, 4694]
cont_range = [4590, 4620, 4740, 4780]

[[imaging.lines]]
line = 'OIIsum_mom0'
wl_range = [3724, 3732]
cont_range = [3710, 3720, 3735, 3750]

[[imaging.lines]]
line = 'SIII9532_mom0'
wl_range = [9529, 9535]
cont_range = [9500, 9520, 9540, 9560]

[[imaging.lines]]
line = 'SIII6312_mom0'
wl_range = [6309, 6315]
cont_range = [6270, 6290, 6320, 6340]

[[imaging.lines]]
line = 'OIII4363_mom0'
wl_range = [4361, 4366]
cont_range = [4320, 4335, 4375, 4395]

[[imaging.lines]]
line = 'NII5755_mom0'
wl_range = [5752, 5758]
cont_range = [5725, 5745, 5762, 5778]

# # === Gaussian fits =====================

[[imaging.lines]]
line = ["Ha", "NII6584"]
wl_range = [6523, 6610]
line_fit = [6562.78, 6583.5, 6548.1]
fix_ratios = [-1, 1, 0.333]
tie_disp = [false, true, true]
tie_vel = [false, true, true]
include_comp = [0, 1, -1] # -1 means not to include this component in the output
filter_sn = 5 # minimal signal-to-noise ratio to consider during imaging

[[imaging.lines]]
line = ["OIII5007"]
wl_range = [4930, 5030]
line_fit = [4958.9, 5006.8]
# max_comps = [2, 2]  # maximal number of components to fit, if needed more than one
fix_ratios = [0.333, 1]
include_comp = [-1, 0]

[[imaging.lines]]
line = ["Hb"]
wl_range = [4840, 4880]
line_fit = [4861.3]
include_comp = [0]

[[imaging.lines]]
line = ["Hg", "OIII4363"]
wl_range = [4325, 4380]
line_fit = [4340.5, 4363.2]
include_comp = [0, 1]
filter_sn = 1

[[imaging.lines]]
line = ["OII3726", "OII3729"]
wl_range = [3700, 3750]
line_fit = [3726.0, 3728.8]
include_comp = [0, 1]

[[imaging.lines]]
line = ["SII6717", "SII6731"]
wl_range = [6680, 6760]
line_fit = [6716.4, 6730.8]
include_comp = [0, 1]

[[imaging.lines]]
line = ["NII5755"]
wl_range = [5730, 5780]
line_fit = [5754.64]
include_comp = [0]

[[imaging.lines]]
line = ["SIII6312"]
wl_range = [6306, 6325]
line_fit = [6312.1]
include_comp = [0]

[[imaging.lines]]
line = ["OII7320", 'OII7330']
wl_range = [7300, 7350]
line_fit = [7320.0, 7330.0]
include_comp = [0, 1]

[[imaging.lines]]
line = ["HeII"]
wl_range = [4670, 4700]
line_fit = [4685.7]
include_comp = [0]

[[imaging.lines]]
line = 'SIII9532'
wl_range = [9500, 9560]
line_fit = [9531.1]
include_comp = [0]

# =======================================
# === Limits For cube reconstruction, if needed =====
# =======================================
[cube_reconstruction]
wl_range = [4990, 5030]
suffix = 'OIII5007'

# =======================================
# ====== Setup for individual objects ====
# =======================================

# ========= New Object =============
[[object]]
name = "Demo" # Name of your object, will be used as folder in output directory
version = "v1.1.1"# version of the files (perhaps, it is good to tag it to the version of the drp)
velocity = 0 # Systemic velocity in km/s (used only for imaging to adjust the flux extraction window)

#### New pointing ### Blocks for individual fiels for the same object
[[object.pointing]]
name = "P1" # Name of current pointing. Will be used as subfolder in the object directory.

[[object.pointing.data]]
mjd = 60496
tileid = [1042796]
exp = [20784]

[[object.pointing.data]]
mjd = 60497
tileid = [1042285]
exp = [20858]

[[object.pointing.data]]
mjd = 60498
tileid = [1042284]
exp = [20926]

[[object.pointing.data]]
mjd = 60500
tileid = [1042795]
exp = [21059]